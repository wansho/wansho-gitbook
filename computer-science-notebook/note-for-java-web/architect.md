# Architect

[TOC]

## 数据库相关

### 业务相关

* 不要用外键
* 任何表都需要设置 ID 主键
* 所有业务相关的数据，不能直接删除，因为后面不知道啥时候还会用到，可以设置一个删除标志位

### MySQL 服务器硬件选型

* MySQL 不支持多核同时运算一条 sql
* CPU 选择原则
  * 对于高并发的场景，CPU 的核心数比频率更重要
  * 对于计算密集型场景，CPU 频率比核心数更重要
* 内存选择原则
  * InnoDB 引擎会将索引和数据缓存到内存中，速度很快，理想的选择是服务器内存大于数据总量
* 硬盘选择原则
  * 优先用 SSD 固态硬盘

### 列数据库

应用场景：批量处理、超大规模即时查询（适用于高查询场景，不适合高增删改场景）

列式存储数据库：HBase, Cassandra(卡三桌)

对于传统的行数据库来说，数据是按照行进行**分散存储**的，在读取数据的时候，磁盘要去寻找匹配的行，从而产生多次 IO，而列数据库的数据是**连续存储**的，IO 消耗很小。

| 行数据库存储                                                 | 列数据库存储                                                 |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20210923195912024](assets/image-20210923195912024.png) | ![image-20210923195831697](assets/image-20210923195831697.png) |

Cassandra 官方宣称其速度比 MySQL 快 100 倍。

**列数据库速度快的原因**：

* 不读取无效数据

  <img align="left" src="assets/image-20210923200225125.png" alt="image-20210923200225125" style="zoom:50%;" />

* 数据压缩比大

  数据相关性大，连续存储的数据，类型都是一样的，可以采用一些算法进行压缩

**列式数据库遗留问题**

* 如何高效新增 —> 多个列族，并发写磁盘
* 如何高效更新 —> Cansandra 添加一个新版本号的数据
* 如何高效删除 —> 添加删除标记 keyType=Delete（逻辑删除）

### 模糊查询

MySQL5.7 开始提供 Ngram 全文检索

传统的 like 在进行检索的时候，索引可能会失效，导致全表检索

```sql
create index idx_title on article(title)
# 可能用到索引,看索引选择性
select * from article where title like ‘Java%’
# 一定不会用到索引
select * from article where title like ‘%Java’
select * from article where title like ‘%Java%’
```

替代方法：将数据同步到 Elasticsearch 进行复杂的模糊查询。但是这个方法也会带来更高的成本：

数据一致性如何保证？ElasticSearch高可用架构采用哪种方案？谁来负责维护 ElasticSearch？

MySQL 给出了折中的方法，从 MySQL 5.7.6 开始，MySQL 内置了 ngram 全文解析器，允许对短文本进行全文检索查询，以替代 like 关键字，对于复杂业务场景的全文检索查询，还是要用 ES

在 MySQL 5.7.6 之前，全文索引只支持英文全文索引，不支持中文全文索引，需要利用分词器把中文段落预处理拆分成单词，然后存入数据库。从 **MySQL 5.7.6** 开始，MySQL内置了 ngram 全文解析器，用来**支持中文**、日文、韩文分词。本文使用的MySQL 版本是 **5.7.24**，**InnoDB**数据库引擎。  

## 时区问题

* UTC 世界时间

  世界时间比格林威治时间准，使用原子钟。

  UTC+8就是国际时加八小时,是东八区时间,是北京时间。

* GMT 格林威治时间

时间解释：`2018-01-31T14:32:19Z`

T代表后面跟着是时间，Z代表0时区（相差北京时间8小时）

2021-09-27T10:45:15.343Z 表示世界时间，其中 343 是毫秒 1s = 1000ms

## 分布式相关



### raft 选举算法

分布式集群中，通常是有一个主节点的，确定主节点的算法，通常是 raft 算法。

目前流行的组件：Consul，Nacos，Rocket MQ 底层都采用了 Raft 算法来确认集群的主节点。

作用：在分布式集群架构下进行主节点的确认。

## 真实案例

### push -> pull -> 数据订阅

| 架构图                                                       | 特点                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20211003082959640](assets/image-20211003082959640.png) | 子系统共用一个账户系统，并且每个子系统都有一个本地库         |
| ![image-20211003083200936](assets/image-20211003083200936.png) | 账户系统修改用户名后，要根据每个子系统提供的接口，推送给每一个子系统。账户系统和子系统耦合非常严重，每增加一个子系统，账户系统都要修改一次代码 |
| ![image-20211003083445956](assets/image-20211003083445956.png) | 改成子系统从账户系统定时 pull 的模式，降低耦合，但是仍然存在账户系统修改接口的风险 |
| ![image-20211003083532775](assets/image-20211003083532775.png) | 将可变因素同步接口进行解耦，引入消息队列，直接订阅数据，不对接口产生依赖 |

