# 应用层

[TOC]



## Socket API

传输层向应用层提供的服务，就是 Socket API，分为 TCP 和 UDP 两种 Socket。



## 分布式进程通信需要解决的问题

在计算机网络中，两个进程的通信，其实是分布式的。我在浏览器(进程)上，访问百度(进程)的资源，是一种分布式的形式。

如果两个进程在同一台机器上，那么就不需要依靠计算机网络来通信了，可以通过操作系统提供的 API，或者管道，共享缓存，来实现进程通信。

分布式进程通信，需要解决的问题：

* 进程标识，寻址问题（主机IP，TCP/UDP，端口号 ）
* 传输层是如何向应用层的应用提供服务的 Socket API
* 应用之间如何实现报文交换



## 分布式应用通信模式

* Client Server 模式
* Peer to Peer 模式 



## 端口号的作用

区分同一台主机上的不同的应用。

在 TCP 和 UDP 的规范中，端口号占 16 个比特，一共有 65536 个端口号。



## 应用层向传输层传输的数据

* 谁发的：主机的 IP 和 端口号
* 谁收的：目标主机的 IP 和端口号
* 货物



## TCP Socket

包含源 IP，源端口，目标 IP，目标端口（四元组）的一个会话关系本地标识。

是应用层和传输层的一个约定，可以用一个整数（句柄，指针）来表示，应用层在和传输层发消息的时候，传给传输层一个整数标识，传输层看到这个标志，就找到了约定好的四元组。这样就避免了每一次向传输层传递信息的时候，都携带四元组的麻烦。便于管理，而且穿过层间的数据最小。

是应用层和传输层之间的一个约定。



对于使用面向连接服务（TCP）的应用而言，套接字是4元组的一个具有本地意义的标示

* 4元组：(源IP，源port，目标IP，目标port)

* 唯一的指定了一个会话（2个进程之间的会话关系）

* 应用使用这个标示，与远程的应用进程通信

* 不必在每一个报文的发送都要指定这4元组

就像使用操作系统打开一个文件，OS返回一个文件句柄一样，以后使用这个文件句柄，而不是使用这个文件的目录名、文件名

![image-20220425202603238](assets/image-20220425202603238.png)

通俗的解释，就是我们有一个稳定的生意伙伴，经常互发文件快递。那么我去顺丰快递那里，把我的大楼（IP），第几层（Port），伙伴的大楼（IP），伙伴第几层（Port）登记下来，顺丰快递返回给我们一个号码，下次寄件的时候，直接把号码和文件告诉顺丰就行了。



## UDP Socket

对于使用无连接服务（UDP）的应用而言，套接字是2元组的一个具有本地意义的标示

* 2元组：IP，port（源端指定）
* UDP套接字指定了应用所在的一个端节点（endpoint）
* 在发送数据报时，采用创建好的本地套接字（标示ID），就不必在发送每个报文中指明自己所采用的ip和port
* 但是在发送报文时，必须要指定对方的 ip 和 udp port(另外一个段节点)

![image-20220425203837380](assets/image-20220425203837380.png)

通俗地解释，就是我们有一个不稳定的伙伴，偶尔会寄文件，我去顺丰快递那里，只登记了我的大楼和楼层，顺丰返回给我一个号码。后面每一次寄文件的时候，我要给顺丰三样东西：我的号码，文件，对方的 ip 和 udp port。



## 应用层协议分类

* 公开协议

  由 RFC 文档定义，允许互操作，如 HTTP，SMTP

* 私有协议

  协议不公开，如 Skype 



## 应用层应用使用的传输层协议

![image-20220425210543707](assets/image-20220425210543707.png)



## 安全性 / SSL

TCP 和 UDP 都没有加密，明文通过互联网传输。



*Secure Sockets Layer* 

SSL 在 TCP 上面实现，提供加密的 TCP 连接。SSL 在应用层。https 跑在 ssl 之上。



## URL 格式

```
Prot://user:password@www.oldschool.edu/someDept/pic.gif:port
```



## HTTP 协议

客户端发起一个与服务器的 TCP 连接（建立套接字），端口号为 TCP-80。

服务端起来后，建立一个守候 Socket，监听 TCP-80 端口，有客户端发起请求后，则建立 socket1，socket2，与客户端进行通信，守候 Socket 不变。



## HTTP 请求报文

HTTP 请求报文都是 ASCII，可读



## HTTP Head 请求

只获取头部，通常用于搜索引擎构建索引。



## Cookie

第一次访问一个网站，没有 Cookie，服务端会返回一个 Cookie，浏览器会存储下来，第二次访问的时候，浏览器就会自动带上这个 Cookie，实现了用户的分辨（有状态）。



## web 缓存



缓存既是客户端，又是服务端，使用缓存的优点：

* 降低客户端的请求响应时间
* 大大降低网络链路的流量
* 使得请求在本地命中，降低了目标服务器的负担

互联网大量采用了缓存，可以使较弱的 ICP 也能提供有效内容（微博热点）

![image-20220428201703879](assets/image-20220428201703879.png)



## FTP 

服务端默认守护的端口：21

客户端的端口：20



## 邮件服务器

端口：25

三个主要组成部分：

* 用户代理（邮件客户端软件）
* 邮件服务器
* 简单邮件传输协议 SMTP

邮件服务器之间的 SMTP 协议：发送 email 报文

客户端：发送方邮件服务器

服务端：接收方邮件服务器

邮件服务器既作为客户端，又作为服务端。

用户代理把邮件发给自己的邮件服务器，使用 SMTP 协议，自己的邮件服务器，把邮件发到对方的邮件服务器，也使用 SMTP 协议。

![image-20220428203735317](assets/image-20220428203735317.png)

用户代理拉取邮件的协议：POP3，IMAP，HTTP。

![image-20220428204830542](assets/image-20220428204830542.png)

SMTP 协议负责推，HTTP/POP3/IMAP 负责拉取。



原始的 SMTP 协议只支持 ASCII 报文。中文一个字占两个字节，需要先经过 base64 编码成 ASCII，然后再传输。
